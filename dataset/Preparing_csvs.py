# -*- coding: utf-8 -*-
"""csv.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1KkfObLi-3S2beMoOKNKbxINJzRurEMCM
"""

!pip install pydub
from pydub import AudioSegment
import pandas as pd
import json
# from .ffprobe import ffprobe
from pydub import AudioSegment

for i in range(22,23):
    

  song = AudioSegment.from_mp3("chap" + str(i) + ".mp3")

  song.export("chap" + str(i) + ".wav", format="wav")
  book = AudioSegment.from_wav("chap" + str(i) + ".wav")
  with open("chap" + str(i) + "_tuned.json") as f: 
      syncmap = json.loads(f.read())

  sentences = []
  for fragment in syncmap['fragments']:
      if ((float(fragment['end'])*1000) - float(fragment['begin'])*1000) > 400:
          sentences.append({"audio":book[float(fragment['begin'])*1000:float(fragment['end'])*1000], "text":fragment['lines'][0]})

  df = pd.DataFrame(columns=['filename', 'wave_size','text'])

  # export audio segment
  import os
  from google.colab import files

  for idx, sentence in enumerate(sentences):
      text = sentence['text'].lower()
      sentence['audio'].export("sample-chap"+str(i)+"-"+str(idx)+".wav", format="wav")
      # xx = sentence['audio'].export("sample-chap"+str(i)+str(idx)+".wav", format="mp3")
      files.download("sample-chap"+str(i)+"-"+str(idx)+".wav")
      # file = "sample-"+str(idx)+".wav"
      temp_df = pd.DataFrame([{'filename':"sample-chap"+str(i)+"-"+str(idx)+".wav",'wave_size': os.path.getsize("sample-chap"+str(i)+"-"+str(idx)+".wav"),'text':text}])
      df = df.append(temp_df)


  df.to_csv("chap" + str(i) + ".csv",index=False)

  df.reset_index().head()
  files.download("chap" + str(i) + ".csv")
  print(i)

#convert mp3 to wav
!pip install pydub
from pydub import AudioSegment
import pandas as pd
import json
# from .ffprobe import ffprobe
from pydub import AudioSegment
song = AudioSegment.from_mp3("lmao.mp3")
song.export("lmao"+ ".wav", format="wav")

# import os
# from google.colab import files

# for idx, sentence in enumerate(sentences):
#     text = sentence['text'].lower()
#     sentence['audio'].export("sample"+"-"+str(idx)+".wav", format="wav")
#     # xx = sentence['audio'].export("sample-chap"+str(i)+str(idx)+".wav", format="mp3")
#     files.download("sample"+"-"+str(idx)+".wav")
#     # file = "sample-"+str(idx)+".wav"
#     temp_df = pd.DataFrame([{'filename':"sample"+"-"+str(idx)+".wav",'wave_size': os.path.getsize("sample"+"-"+str(idx)+".wav"),'text':text}])
#     df = df.append(temp_df)
#     print(idx)

# df.to_csv("lmao"+ ".csv",index=False)

# df.reset_index().head()
# # files.download("lmao" + ".csv")